<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Inventario John Silver - Sistema Premium</title>
    <!-- QuaggaJS para escaneo de c√≥digos de barras -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <!-- Chart.js para gr√°ficas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <!-- Firebase SDK v10 Compat (Corregido de la v12 que no existe) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #1e293b; --primary-dark: #0f172a; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6; --border: #e2e8f0; --bg: #f8fafc; --text: #1e293b; --text-light: #64748b; --shadow: 0 1px 3px rgba(0,0,0,0.1); --shadow-md: 0 4px 6px rgba(0,0,0,0.1); --shadow-lg: 0 10px 15px rgba(0,0,0,0.1); --radius: 0.75rem; --radius-lg: 1rem; }
        
        /* ======== LOGIN SCREEN STYLES ======== */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 100000; }
        .login-container { background: white; border-radius: 1rem; padding: 2.5rem; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .login-header { text-align: center; margin-bottom: 2rem; }
        .login-logo { font-size: 3rem; margin-bottom: 1rem; }
        .login-title { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; }
        .login-subtitle { color: var(--text-light); font-size: 0.875rem; }
        .login-form { display: flex; flex-direction: column; gap: 1rem; }
        .login-input-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .login-label { font-size: 0.875rem; font-weight: 600; color: var(--text); }
        .login-input { padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; font-size: 1rem; transition: all 0.2s; width: 100%; }
        .login-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .login-checkbox-group { display: flex; align-items: center; gap: 0.5rem; }
        .login-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .login-checkbox-label { font-size: 0.875rem; color: var(--text-light); cursor: pointer; user-select: none; }
        .login-btn { padding: 0.875rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 0.5rem; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .login-btn:active { transform: translateY(0); }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .login-error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; display: none; }
        .login-success { background: #d1fae5; border: 1px solid #a7f3d0; color: #059669; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; display: none; }
        .login-info { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); text-align: center; }
        .login-info-text { font-size: 0.75rem; color: var(--text-light); line-height: 1.5; }
        .login-register-btn { margin-top: 1rem; padding: 0.75rem; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; width: 100%; }
        .login-register-btn:hover { background: #667eea; color: white; }
        .login-mode-toggle { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; }
        .mode-btn { padding: 0.5rem 1rem; background: #f3f4f6; border: 2px solid transparent; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; }
        .mode-btn.active { background: white; border-color: #667eea; color: #667eea; }
        
        /* ======== SYNC STATUS BAR ======== */
        #sync-status-bar { position: fixed; top: 0; left: 0; right: 0; height: 3px; background: #10b981; z-index: 10000; display: none; animation: pulse 2s infinite; }
        #sync-status-bar.syncing { display: block; background: #f59e0b; }
        #sync-status-bar.error { display: block; background: #ef4444; }

        /* ======== MAIN APP ======== */
        #main-app { display: none; }
        #main-app.authenticated { display: block; }

        /* Animations & General */
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-in { animation: fadeIn 0.3s ease; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); color: var(--text); line-height: 1.6; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 1rem; }

        /* Header & Layout */
        header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
        .header-top { padding: 0.75rem 0; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .logo-section { display: flex; align-items: center; gap: 0.75rem; }
        .logo { width: 42px; height: 42px; border-radius: var(--radius); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; background: white; cursor: pointer; position: relative; overflow: hidden; transition: all 0.3s; }
        .logo:hover { transform: scale(1.05); border-color: var(--primary); }
        .logo img { width: 100%; height: 100%; object-fit: cover; }
        .logo-upload { display: none; }
        .brand-name { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; color: var(--primary); }
        .header-actions { margin-left: auto; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .user-info { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--bg); border-radius: var(--radius); font-size: 0.875rem; }
        .user-email { color: var(--text); font-weight: 500; }
        .logout-btn { padding: 0.5rem 0.75rem; background: var(--danger); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; }
        .logout-btn:hover { background: #dc2626; transform: translateY(-1px); }
        .operator-input { padding: 0.5rem 0.75rem; border: 2px solid var(--border); border-radius: var(--radius); background: white; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .operator-input:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30,41,59,0.1); }
        .operator-input input { border: none; outline: none; width: 140px; font-size: 0.875rem; }
        .btn { padding: 0.5rem 1rem; border-radius: var(--radius); border: 2px solid var(--border); background: white; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; white-space: nowrap; }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; border-color: var(--success); }
        .btn-danger { background: var(--danger); color: white; border-color: var(--danger); }
        .btn-warning { background: var(--warning); color: white; border-color: var(--warning); }
        .btn-outline-danger { color: var(--danger); border-color: var(--danger); background: white; }
        .btn-outline-danger:hover { background: #fef2f2; }
        .tabs { display: flex; gap: 0; padding: 0; border-top: 1px solid var(--border); background: white; overflow-x: auto; }
        .tab { padding: 0.75rem 1.25rem; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); transition: all 0.2s; white-space: nowrap; font-weight: 500; position: relative; }
        .tab:hover { color: var(--text); background: var(--bg); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--bg); }
        .tab.active::after { content: ''; position: absolute; bottom: -3px; left: 0; right: 0; height: 3px; background: var(--primary); }
        
        /* Stats & Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .stat-card { background: white; border-radius: var(--radius-lg); padding: 1.25rem; display: flex; align-items: center; gap: 1rem; transition: all 0.3s; box-shadow: var(--shadow); animation: fadeIn 0.4s ease; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .stat-card.clickable { cursor: pointer; }
        .stat-icon-wrapper { width: 48px; height: 48px; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; background: var(--bg); }
        .stat-content { flex: 1; min-width: 0; }
        .stat-label { font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-icon { font-size: 1.5rem; opacity: 0.8; }
        .model-summary { background: white; border-radius: var(--radius-lg); padding: 1.25rem; margin: 1rem 0; box-shadow: var(--shadow); }
        .model-summary-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; font-weight: 600; color: var(--primary); }
        .model-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; padding-bottom: 0.5rem; position: relative; }
        .model-tag { padding: 0.5rem 1rem; border-radius: 999px; border: 1px solid var(--border); background: var(--bg); font-size: 0.875rem; transition: all 0.2s; cursor: pointer; position: relative; user-select: none; }
        .model-tag:hover { background: white; border-color: var(--primary); transform: scale(1.05); box-shadow: var(--shadow); }
        .model-tag:active { transform: scale(0.98); }
        .model-tag.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.2); font-weight: 600; }
        .model-tag.active strong { color: white; }
        
        /* Scanner & Forms */
        .scan-panel { background: white; border-radius: var(--radius-lg); padding: 1.5rem; margin: 1rem 0; box-shadow: var(--shadow); animation: fadeIn 0.3s ease; }
        .scan-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.25rem; font-weight: 600; color: var(--primary); }
        .scan-form { display: grid; gap: 1rem; }
        .scan-row { display: grid; grid-template-columns: 1fr auto auto auto; gap: 0.5rem; align-items: end; flex-wrap: wrap; }
        .input-group { position: relative; }
        .input-label { display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .input-group input, .input-group select { width: 100%; padding: 0.625rem 0.875rem; border: 2px solid var(--border); border-radius: var(--radius); outline: none; transition: all 0.2s; font-size: 0.875rem; }
        .input-group input:focus, .input-group select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30,41,59,0.1); }
        .input-icon { position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); opacity: 0.5; }
        .input-group.with-icon input { padding-left: 2.75rem; }
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 0.875rem; background: var(--bg); border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
        .checkbox-group:hover { border-color: var(--primary); background: white; }
        .checkbox-group input[type="checkbox"] { cursor: pointer; }
        .mobile-scanner-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 600; border-radius: var(--radius); display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
        .mobile-scanner-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .mobile-scanner-btn:active { transform: translateY(0); }
        .mobile-scanner-btn .icon { font-size: 1rem; }
        
        /* Scanner Modal */
        .scanner-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); z-index: 2000; overflow: hidden; }
        .scanner-modal.active { display: block; }
        .scanner-container { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; }
        .scanner-header { position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); color: white; padding: 1rem; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .scanner-close { background: rgba(255, 255, 255, 0.2); border: 2px solid white; color: white; padding: 0.5rem 1rem; border-radius: var(--radius); font-size: 1rem; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); }
        #scanner-viewport { position: relative; width: 100%; height: 100%; overflow: hidden; background: #000; }
        #scanner-viewport video { width: 100%; height: 100%; object-fit: cover; }
        #scanner-viewport canvas { display: none; }
        .scanner-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 300px; height: 200px; border: 3px solid #10b981; border-radius: var(--radius); box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); animation: pulse 2s infinite; pointer-events: none; }
        .scanner-overlay::before, .scanner-overlay::after { content: ''; position: absolute; width: 30px; height: 30px; border: 3px solid #10b981; }
        .scanner-overlay::before { top: -3px; left: -3px; border-right: none; border-bottom: none; }
        .scanner-overlay::after { bottom: -3px; right: -3px; border-left: none; border-top: none; }
        .scanner-status { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; padding: 2rem 1rem; text-align: center; z-index: 10; }
        .scanner-status-text { font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; animation: pulse 1.5s infinite; }
        .scanner-status-text.verifying { color: #f59e0b; animation: pulse 0.5s infinite; }
        .scanner-status-code { font-size: 1.5rem; font-weight: 700; color: #10b981; font-family: monospace; padding: 0.5rem 1rem; background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: var(--radius); display: inline-block; margin-top: 0.5rem; }
        
        /* Tables & Products */
        .products-section { background: white; border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow); margin: 1rem 0; animation: fadeIn 0.4s ease; }
        .products-header { padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; background: var(--bg); }
        .filters { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .search-input { padding: 0.5rem 0.875rem; border: 2px solid var(--border); border-radius: var(--radius); outline: none; min-width: 200px; transition: all 0.2s; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30,41,59,0.1); }
        .filter-btn { padding: 0.5rem 0.875rem; border: 2px solid var(--border); border-radius: var(--radius); background: white; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.375rem; }
        .filter-btn:hover { background: var(--bg); transform: translateY(-1px); }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bg); }
        th { padding: 0.875rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--border); }
        td { padding: 0.875rem; border-bottom: 1px solid var(--border); }
        tbody tr { transition: all 0.2s; }
        tbody tr:hover { background: var(--bg); }
        .model-header { background: linear-gradient(to right, #f8fafc, transparent); font-weight: 600; color: var(--primary); }
        .product-image { width: 48px; height: 48px; border-radius: var(--radius); border: 1px solid var(--border); object-fit: cover; }
        .product-image-placeholder { width: 48px; height: 48px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg); display: flex; align-items: center; justify-content: center; color: var(--text-light); }
        .stock-badge { padding: 0.25rem 0.625rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .stock-zero { background: #fef2f2; color: #ef4444; }
        .stock-low { background: #fef3c7; color: #f59e0b; }
        .stock-ok { background: #d1fae5; color: #10b981; }
        .action-buttons { display: flex; gap: 0.375rem; justify-content: flex-end; }
        .action-btn { padding: 0.375rem 0.625rem; border-radius: var(--radius); border: 1px solid var(--border); background: white; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; font-weight: 500; }
        .action-btn:hover { transform: scale(1.1); box-shadow: var(--shadow); }
        .action-btn.plus { background: var(--success); color: white; border-color: var(--success); }
        .action-btn.minus { background: var(--danger); color: white; border-color: var(--danger); }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(4px); }
        .modal.show { display: flex; animation: fadeIn 0.2s ease; }
        .modal-content { background: white; border-radius: var(--radius-lg); max-width: 700px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); animation: slideUp 0.3s ease; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--primary); }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); padding: 0.25rem; display: flex; align-items: center; justify-content: center; border-radius: var(--radius); transition: all 0.2s; }
        .modal-close:hover { background: var(--border); color: var(--text); }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .form-input { width: 100%; padding: 0.625rem 0.875rem; border: 2px solid var(--border); border-radius: var(--radius); outline: none; transition: all 0.2s; }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30,41,59,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        
        /* Notifications & Utilities */
        .notifications { position: fixed; bottom: 1rem; right: 1rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
        .notification { background: white; padding: 1rem 1.25rem; border-radius: var(--radius); box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 0.75rem; min-width: 280px; animation: slideIn 0.3s ease; border-left: 4px solid; }
        .notification.success { border-left-color: var(--success); }
        .notification.error { border-left-color: var(--danger); }
        .notification.warning { border-left-color: var(--warning); }
        .notification.info { border-left-color: var(--info); }
        .notification-icon { font-size: 1.25rem; }
        .notification-message { flex: 1; font-size: 0.875rem; color: var(--text); }
        .notification-close { margin-left: auto; cursor: pointer; opacity: 0.6; font-size: 1.25rem; transition: opacity 0.2s; }
        .notification-close:hover { opacity: 1; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid var(--border); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        .empty-state { padding: 3rem; text-align: center; color: var(--text-light); }
        .empty-state-icon { font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; }
        .empty-state-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text); }
        
        @media (max-width: 768px) {
            .header-actions { width: 100%; justify-content: space-between; }
            .stats-grid { grid-template-columns: 1fr; }
            .scan-row { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .filters { width: 100%; }
            .search-input { width: 100%; }
            .model-tags { gap: 0.25rem; }
            .model-tag { padding: 0.375rem 0.75rem; font-size: 0.75rem; }
            .mobile-scanner-btn { font-size: 0.8rem; padding: 0.75rem 1rem; flex: 1; min-width: 150px; }
            .scan-panel button[type="submit"] { flex: 1; min-width: 150px; }
        }
        canvas { max-height: 300px; min-height: 200px; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- ======== SYNC STATUS BAR ======== -->
    <div id="sync-status-bar"></div>

    <!-- ======== LOGIN SCREEN ======== -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">üì¶</div>
                <h1 class="login-title">Inventario John Silver</h1>
                <p class="login-subtitle">Sistema Premium de Gesti√≥n</p>
            </div>
            <div class="login-mode-toggle">
                <button class="mode-btn active" onclick="toggleLoginMode('login')">Iniciar Sesi√≥n</button>
                <button class="mode-btn" onclick="toggleLoginMode('register')">Registrarse</button>
            </div>
            <form class="login-form" id="login-form" onsubmit="handleLogin(event)">
                <div class="login-input-group">
                    <label class="login-label">Correo Electr√≥nico</label>
                    <input type="email" class="login-input" id="login-email" required placeholder="tu@email.com">
                </div>
                <div class="login-input-group">
                    <label class="login-label">Contrase√±a</label>
                    <input type="password" class="login-input" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                </div>
                <div class="login-checkbox-group">
                    <input type="checkbox" class="login-checkbox" id="remember-me">
                    <label for="remember-me" class="login-checkbox-label">Recordar sesi√≥n</label>
                </div>
                <div class="login-error" id="login-error"></div>
                <div class="login-success" id="login-success"></div>
                <button type="submit" class="login-btn" id="login-submit-btn">Iniciar Sesi√≥n</button>
            </form>
            <form class="login-form" id="register-form" style="display: none;" onsubmit="handleRegister(event)">
                <div class="login-input-group">
                    <label class="login-label">Correo Electr√≥nico</label>
                    <input type="email" class="login-input" id="register-email" required placeholder="tu@email.com">
                </div>
                <div class="login-input-group">
                    <label class="login-label">Contrase√±a</label>
                    <input type="password" class="login-input" id="register-password" required placeholder="M√≠nimo 6 caracteres" minlength="6">
                </div>
                <div class="login-input-group">
                    <label class="login-label">Confirmar Contrase√±a</label>
                    <input type="password" class="login-input" id="register-password-confirm" required placeholder="Repite la contrase√±a" minlength="6">
                </div>
                <div class="login-error" id="register-error"></div>
                <div class="login-success" id="register-success"></div>
                <button type="submit" class="login-btn" id="register-submit-btn">Crear Cuenta</button>
            </form>
            <div class="login-info">
                <p class="login-info-text">
                    üîí Conexi√≥n segura con Firebase<br>
                    ‚òÅÔ∏è Sincronizaci√≥n en tiempo real<br>
                    üì± Acceso desde m√∫ltiples dispositivos
                </p>
            </div>
        </div>
    </div>

    <!-- ======== MAIN APP (oculto hasta login) ======== -->
    <div id="main-app">
        <header>
            <div class="container">
                <div class="header-top">
                    <div class="logo-section">
                        <label class="logo">
                            <span id="logoPlaceholder">ü™ô</span>
                            <img id="logoImg" style="display: none;" alt="Logo">
                            <input type="file" class="logo-upload" accept="image/*" onchange="handleLogoUpload(event)">
                        </label>
                        <div class="brand-name">
                            <span>üì¶</span>
                            <span>Inventario John Silver</span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <div class="user-info">
                            <span>üë§</span>
                            <span class="user-email" id="current-user-email">-</span>
                        </div>
                        <button class="btn" onclick="forceSyncFromFirebase()">üîÑ Sincronizar</button>
                        <div class="operator-input">
                            <span>üë§</span>
                            <input type="text" id="operatorInput" placeholder="Operador">
                        </div>
                        <button class="btn btn-primary" onclick="openAddModal()"><span>‚ûï</span> Nuevo</button>
                        <button class="btn" onclick="exportProductsCSV()"><span>üìä</span> Exportar CSV</button>
                        <button class="btn" onclick="exportMovementsCSV()"><span>üìã</span> Movimientos</button>
                        <button class="btn" onclick="exportJSON()"><span>üíæ</span> Respaldo</button>
                        <button class="btn" onclick="openBulkModal()"><span>üì§</span> Carga masiva</button>
                        <button class="btn btn-outline-danger" onclick="clearAll()"><span>üóëÔ∏è</span> Vaciar</button>
                        <button class="btn" onclick="toggleValues()">
                            <span id="valuesIcon">üëÅÔ∏è</span>
                            <span id="valuesText">Ver datos</span>
                        </button>
                        <button class="logout-btn" onclick="handleLogout()">üö™ Salir</button>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab active" onclick="setTab('entradas', this)" data-tab="entradas"><span>‚¨áÔ∏è</span> Entradas</button>
                    <button class="tab" onclick="setTab('salidas', this)" data-tab="salidas"><span>‚¨ÜÔ∏è</span> Salidas</button>
                    <button class="tab" onclick="setTab('productos', this)" data-tab="productos"><span>üì¶</span> Productos</button>
                    <button class="tab" onclick="setTab('movimientos', this)" data-tab="movimientos"><span>üìã</span> Movimientos</button>
                    <button class="tab" onclick="setTab('analytics', this)" data-tab="analytics"><span>üìä</span> Analytics<span style="font-size: 0.7rem; margin-left: 0.25rem;">üîê</span></button>
                    <button class="tab" onclick="setTab('herramientas', this)" data-tab="herramientas"><span>‚öôÔ∏è</span> Herramientas</button>
                </div>
            </div>
        </header>

        <main class="container">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card animate-in">
                    <div class="stat-icon-wrapper"><span class="stat-icon">üì¶</span></div>
                    <div class="stat-content"><div class="stat-label">Productos</div><div class="stat-value" id="statProducts">0</div></div>
                </div>
                <div class="stat-card animate-in" style="animation-delay: 0.1s;">
                    <div class="stat-icon-wrapper"><span class="stat-icon">üíñ</span></div>
                    <div class="stat-content"><div class="stat-label">Unidades Totales</div><div class="stat-value" id="statUnits">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div></div>
                </div>
                <div class="stat-card clickable animate-in" onclick="toggleValues()" style="animation-delay: 0.2s;">
                    <div class="stat-icon-wrapper"><span class="stat-icon">üí∞</span></div>
                    <div class="stat-content"><div class="stat-label">Valor Total</div><div class="stat-value" id="statValue">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div></div>
                </div>
                <div class="stat-card clickable animate-in" onclick="showLowStock()" style="animation-delay: 0.3s;">
                    <div class="stat-icon-wrapper"><span class="stat-icon" id="lowStockIcon">‚ö†Ô∏è</span></div>
                    <div class="stat-content"><div class="stat-label">Stock Bajo</div><div class="stat-value" id="statLowStock">0</div></div>
                </div>
            </div>

            <!-- Model Summary -->
            <div id="modelSummary" class="model-summary" style="display: none;">
                <div class="model-summary-header"><span>üè∑Ô∏è</span><span>Resumen por modelo</span></div>
                <div class="model-tags" id="modelTags"></div>
            </div>

            <!-- Scan Panel -->
            <div id="scanPanel" class="scan-panel">
                <div class="scan-header"><span>üì∏</span><span id="scanTitle">Entradas ‚Ä¢ Escaneo r√°pido</span></div>
                <form class="scan-form" onsubmit="processScan(event)" autocomplete="off">
                    <div class="scan-row">
                        <div class="input-group with-icon">
                            <label class="input-label">C√≥digo de barras, QR o RFID</label>
                            <span class="input-icon">|||||</span>
                            <input type="search" id="barcodeInput" placeholder="Escanea o escribe..." autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" data-form-type="other" data-lpignore="true" data-1p-ignore="true" aria-autocomplete="none" autofocus>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tipo</label>
                            <select id="scanType" disabled><option value="entrada">Entrada</option><option value="salida">Salida</option></select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Cantidad</label>
                            <input type="number" id="scanQty" value="1" min="1" style="width: 100px;">
                        </div>
                        <label class="checkbox-group">
                            <input type="checkbox" id="autoPlus" checked><span>Auto +1</span>
                        </label>
                    </div>
                    <div class="scan-row">
                        <div class="input-group">
                            <label class="input-label">Plataforma de venta</label>
                            <select id="platformSelect"><option value="">(Sin plataforma)</option></select>
                        </div>
                        <label class="checkbox-group">
                            <input type="checkbox" id="addTracking"><span>üì¶ A√±adir gu√≠a</span>
                        </label>
                        <label class="checkbox-group" id="returnGroup">
                            <input type="checkbox" id="isReturn"><span>üîÑ Es devoluci√≥n</span>
                        </label>
                        <label class="checkbox-group" id="noGuideGroup" style="display: none;">
                            <input type="checkbox" id="noGuide"><span>‚ùå Sin gu√≠a</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
                        <button type="button" class="mobile-scanner-btn" onclick="openMobileScanner()">
                            <span class="icon">üì±</span><span>Escanear con C√°mara</span>
                        </button>
                        <button type="submit" class="btn btn-success">
                            <span id="scanIcon">‚¨áÔ∏è</span>Registrar movimiento manual
                        </button>
                        <div id="pendingGuide" style="display: none; padding: 0.625rem; background: #d1fae5; border-radius: 0.5rem; color: #10b981; flex: 1;">
                            ‚úÖ Gu√≠a lista: <strong id="pendingGuideText"></strong>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Products Section -->
            <div id="productsSection" class="products-section" style="display: none;">
                <div class="products-header">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>üîç</span><strong>Productos</strong>
                        <span id="productsCount" style="font-size: 0.875rem; color: var(--text-light);">(0 total)</span>
                    </div>
                    <div class="filters">
                        <input type="text" class="search-input" id="searchInput" placeholder="Buscar...">
                        <button class="filter-btn active" onclick="setColorFilter('all')"><span>üé®</span> Todos colores</button>
                        <div id="colorFilters"></div>
                        <button class="filter-btn active" onclick="setModelFilter('all')" id="modelFilterAll"><span>üëî</span> Todos modelos</button>
                        <div id="modelFilters"></div>
                        <button class="filter-btn" onclick="setBarcodeFilter()" id="barcodeFilterBtn"><span>üö´</span> Sin c√≥digo</button>
                        <button class="filter-btn" onclick="setLowStockFilter()" id="lowStockFilterBtn"><span>‚ö†Ô∏è</span> Stock bajo</button>
                        <button class="btn" onclick="clearAllFilters()" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;"><span>üîÑ</span> Limpiar filtros</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th><th>Modelo</th><th>C√≥digo</th><th>Nombre</th><th>Color</th><th>Talla</th><th>Precio</th><th>Stock M√≠n.</th><th>Stock</th><th>Plataforma</th><th>Gu√≠a</th><th style="text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Movements Section -->
            <div id="movementsSection" class="products-section" style="display: none;">
                <div class="products-header">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>üìã</span><strong>Movimientos</strong>
                        <span id="movementsCount" style="font-size: 0.875rem; color: var(--text-light);">(0 total)</span>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha y Hora</th><th>C√≥digo</th><th>Producto</th><th>Talla</th><th>Color</th><th>Modelo</th><th>Tipo</th><th style="text-align: right;">Cantidad</th><th>Operador</th><th>Plataforma</th><th>Gu√≠a</th><th>Devoluci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="movementsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tools Section -->
            <div id="toolsSection" class="products-section" style="display: none;">
                <div style="padding: 1.5rem;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary);">‚öôÔ∏è Herramientas y Configuraci√≥n</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4 style="margin-bottom: 1rem; color: var(--text);">üì± Plataformas de venta</h4>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <input type="text" id="newPlatform" placeholder="Nueva plataforma (ej: Shein, MercadoLibre)" class="form-input">
                                <button class="btn btn-primary" onclick="addPlatform()">Agregar</button>
                            </div>
                            <div id="platformsList"></div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 1rem; color: var(--text);">üîê Seguridad Analytics</h4>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <input type="password" id="adminPassword" placeholder="Contrase√±a para analytics" class="form-input">
                                <button class="btn" onclick="savePassword()">Guardar</button>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--text-light);">Esta contrase√±a protege: valores, unidades y analytics.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section (Protected) -->
            <div id="analyticsSection" class="products-section" style="display: none;">
                <div style="padding: 1.5rem;">
                    <div id="analyticsLocked" style="text-align: center; padding: 4rem 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üîê</div>
                        <h3 style="color: var(--primary); margin-bottom: 1rem;">√Årea Protegida</h3>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem;">Analytics requiere contrase√±a de administrador para acceder</p>
                        <button class="btn btn-primary" onclick="unlockAnalytics()"><span>üîì</span> Desbloquear Analytics</button>
                    </div>
                    
                    <div id="analyticsContent" style="display: none;">
                        <h3 style="margin-bottom: 1.5rem; color: var(--primary);">
                            üìä Analytics y M√©tricas
                            <button class="btn" onclick="lockAnalytics()" style="float: right; font-size: 0.875rem;"><span>üîí</span> Bloquear</button>
                        </h3>
                        
                        <!-- Resumen de m√©tricas -->
                        <div class="stats-grid" style="margin-bottom: 2rem;">
                            <div class="stat-card"><div class="stat-icon-wrapper"><span class="stat-icon">üìà</span></div><div class="stat-content"><div class="stat-label">Ventas del Mes</div><div class="stat-value" id="monthSales">0</div></div></div>
                            <div class="stat-card"><div class="stat-icon-wrapper"><span class="stat-icon">üí∞</span></div><div class="stat-content"><div class="stat-label">Valor Vendido</div><div class="stat-value" id="monthRevenue">$0</div></div></div>
                            <div class="stat-card"><div class="stat-icon-wrapper"><span class="stat-icon">üì¶</span></div><div class="stat-content"><div class="stat-label">Rotaci√≥n Promedio</div><div class="stat-value" id="avgRotation">0%</div></div></div>
                            <div class="stat-card"><div class="stat-icon-wrapper"><span class="stat-icon">‚ö°</span></div><div class="stat-content"><div class="stat-label">Producto Estrella</div><div class="stat-value" id="topProduct" style="font-size: 1rem;">-</div></div></div>
                        </div>
                        
                        <!-- Gr√°ficas -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="background: white; padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow);">
                                <h4 style="margin-bottom: 1rem; color: var(--text);">üìä Movimientos Diarios (√öltimos 30 d√≠as)</h4>
                                <canvas id="dailyMovementsChart"></canvas>
                            </div>
                            <div style="background: white; padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow);">
                                <h4 style="margin-bottom: 1rem; color: var(--text);">ü•á Top 10 Productos M√°s Vendidos</h4>
                                <canvas id="topProductsChart"></canvas>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div style="background: white; padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow);">
                                <h4 style="margin-bottom: 1rem; color: var(--text);">üìà Tendencia de Inventario</h4>
                                <canvas id="inventoryTrendChart"></canvas>
                            </div>
                            <div style="background: white; padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow);">
                                <h4 style="margin-bottom: 1rem; color: var(--text);">üè∑Ô∏è Distribuci√≥n por Categor√≠as</h4>
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Scanner Modal -->
        <div id="scannerModal" class="scanner-modal">
            <div class="scanner-container">
                <div class="scanner-header">
                    <h3 style="margin: 0; font-size: 1.25rem;">üì± Esc√°ner de C√≥digos</h3>
                    <button class="scanner-close" onclick="closeMobileScanner()">‚úï Cerrar</button>
                </div>
                <div id="scanner-viewport"><div class="scanner-overlay"></div></div>
                <div class="scanner-status">
                    <div class="scanner-status-text" id="scannerStatusText">üîç Apunta la c√°mara al c√≥digo de barras o QR</div>
                    <div id="scannerResult" style="display: none;">
                        <div class="scanner-status-code" id="scannerResultCode"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="addModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">‚ûï Nuevo Producto</h3>
                    <button class="modal-close" onclick="closeModal('addModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="productForm" onsubmit="saveProduct(event)">
                        <div class="form-group"><label class="form-label">C√≥digo de barras</label><input type="text" id="modalBarcode" class="form-input" placeholder="7501234567890"></div>
                        <div class="form-group"><label class="form-label">Nombre del producto</label><input type="text" id="modalName" class="form-input" placeholder="Pantal√≥n Slim Fit" required></div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Color</label><input type="text" id="modalColor" class="form-input" placeholder="Azul marino" required></div>
                            <div class="form-group"><label class="form-label">Talla</label><input type="text" id="modalSize" class="form-input" placeholder="32"></div>
                        </div>
                        <div class="form-group"><label class="form-label">Modelo</label><input type="text" id="modalModel" class="form-input" placeholder="Slim, Skinny, Regular..."></div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Precio</label><input type="number" id="modalPrice" class="form-input" step="0.01" placeholder="599.90"></div>
                            <div class="form-group"><label class="form-label">Stock m√≠nimo</label><input type="number" id="modalMinStock" class="form-input" value="0" min="0"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Stock inicial</label><input type="number" id="modalStock" class="form-input" value="0" min="0"></div>
                            <div class="form-group"><label class="form-label">Centro/Almac√©n</label><input type="text" id="modalCenter" class="form-input" value="General"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Plataforma</label><input type="text" id="modalPlatform" class="form-input" placeholder="Shein, MercadoLibre..."></div>
                            <div class="form-group"><label class="form-label">N√∫mero de gu√≠a</label><input type="text" id="modalTracking" class="form-input" placeholder="Tracking/Gu√≠a"></div>
                        </div>
                        <div class="form-group"><label class="form-label">URL de imagen</label><input type="url" id="modalImage" class="form-input" placeholder="https://..."></div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">üíæ Guardar producto</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="bulkModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üì§ Carga Masiva CSV</h3>
                    <button class="modal-close" onclick="closeModal('bulkModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <div style="background: var(--bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <p style="font-size: 0.875rem; font-weight: 600;">üìã Formato CSV esperado:</p>
                        <code style="font-size: 0.75rem; display: block; margin-top: 0.5rem;">barcode,name,color,size,model,unit,center,minStock,price,stock,platform,tracking,image</code>
                        <button class="btn btn-primary" onclick="downloadCSVTemplate()" style="margin-top: 0.75rem;">üìù Descargar plantilla</button>
                    </div>
                    <div class="form-group"><label class="form-label">Archivo CSV</label><input type="file" accept=".csv,text/csv" id="csvFile" class="form-input"></div>
                    <div class="form-group"><label class="form-label">O pega el CSV aqu√≠</label><textarea id="csvText" class="form-input" rows="10" placeholder="barcode,name,color,size,model..."></textarea></div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="processCSV('merge')">‚úÖ Importar (fusionar)</button>
                        <button class="btn btn-danger" onclick="processCSV('replace')">‚ö†Ô∏è Reemplazar todo</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div id="notifications" class="notifications"></div>
    </div>

    <script>
        // ==================== CONFIGURACI√ìN FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCjF2wFoedIJZOvQXH2L8TUdlwof3bbHaY",
            authDomain: "inventario5js.firebaseapp.com",
            databaseURL: "https://inventario5js-default-rtdb.firebaseio.com",
            projectId: "inventario5js",
            storageBucket: "inventario5js.firebasestorage.app",
            messagingSenderId: "1038504692737",
            appId: "1:1038504692737:web:e90147dbf8250970514400",
            measurementId: "G-3D88KPTTMJ"
        };

        // Variables globales de Firebase
        let firebaseApp = null;
        let database = null;
        let auth = null;
        let currentUser = null;
        let isOnline = false;
        let syncInProgress = false;
        let lastSyncTime = 0;
        let preventSync = false; // Flag para prevenir sincronizaci√≥n autom√°tica durante guardado

        // ==================== ESTADO DE LA APLICACI√ìN ====================
        let state = {
            products: [],
            movements: [],
            operator: '',
            platforms: [],
            adminPassword: '',
            brandLogo: '',
            valuesUnlocked: false,
            currentTab: 'entradas',
            searchQuery: '',
            colorFilter: 'all',
            modelFilter: 'all',
            barcodeFilter: 'all',
            lowStockFilter: false,
            pendingGuide: '',
            editingProduct: null,
            scannerActive: false
        };
        
        // Intentar cargar estado desde localStorage al inicio
        try {
            const savedState = localStorage.getItem('inventory_state');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                if (parsedState.products) {
                    state = { ...state, ...parsedState };
                    console.log('üì¶ Estado cargado desde localStorage');
                }
            }
        } catch (e) {
            console.log('‚ö†Ô∏è No se pudo cargar estado desde localStorage:', e);
        }

        // ==================== SISTEMA DE AUTENTICACI√ìN ====================
        const AuthSystem = {
            init() {
                try {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    auth = firebase.auth();
                    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    
                    auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            currentUser = user;
                            console.log('‚úÖ Usuario autenticado:', user.email);
                            const lastLoginTime = localStorage.getItem('last_login_time');
                            const currentTime = Date.now();
                            const isNewLogin = lastLoginTime && (currentTime - parseInt(lastLoginTime) < 5000);
                            if (isNewLogin) localStorage.setItem('last_login_time', currentTime.toString());
                            await this.onLoginSuccess(user, isNewLogin);
                        } else {
                            currentUser = null;
                            console.log('‚ùå Usuario no autenticado');
                            this.showLoginScreen();
                        }
                    });
                    
                    const connectedRef = firebase.database().ref('.info/connected');
                    connectedRef.on('value', (snapshot) => {
                        isOnline = snapshot.val() === true;
                        updateConnectionStatus(isOnline);
                    });
                } catch (error) {
                    console.error('Error inicializando Firebase:', error);
                    showError('Error al inicializar el sistema: ' + error.message);
                }
            },
            
            showLoginScreen() {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-app').classList.remove('authenticated');
                document.getElementById('main-app').style.display = 'none';
            },
            
            async onLoginSuccess(user, isNewLogin = false) {
                try {
                    showSyncStatus('syncing');
                    
                    // --- INICIO BLINDAJE: Activar listeners de despertar ---
                    SyncSystem.initWakeUpListeners();
                    
                    if (isNewLogin) {
                        console.log('üÜï Nuevo login detectado - limpiando datos locales...');
                        localStorage.clear();
                        state = {
                            products: [], movements: [], operator: '', platforms: [],
                            adminPassword: '', brandLogo: '', valuesUnlocked: false,
                            currentTab: 'entradas', searchQuery: '', colorFilter: 'all',
                            modelFilter: 'all', barcodeFilter: 'all', lowStockFilter: false,
                            pendingGuide: '', editingProduct: null, scannerActive: false
                        };
                    } else {
                        const savedState = localStorage.getItem('inventory_state');
                        if (savedState) {
                            const parsedState = JSON.parse(savedState);
                            state.products = parsedState.products || [];
                            state.movements = parsedState.movements || [];
                            state.operator = parsedState.operator || '';
                            state.platforms = parsedState.platforms || [];
                            state.adminPassword = parsedState.adminPassword || '';
                            state.brandLogo = parsedState.brandLogo || '';
                        }
                    }
                    
                    console.log('‚òÅÔ∏è Sincronizando con Firebase...');
                    await SyncSystem.downloadFromFirebase();
                    
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app').classList.add('authenticated');
                    document.getElementById('main-app').style.display = 'block';
                    document.getElementById('current-user-email').textContent = user.email;
                    
                    if (document.getElementById('operatorInput')) document.getElementById('operatorInput').value = state.operator || '';
                    
                    updateStats();
                    renderProducts();
                    updateModelSummary();
                    renderMovements();
                    updatePlatformSelects();
                    
                    SyncSystem.startRealtimeSync();
                    showSyncStatus('success');
                    notify('‚úÖ Sesi√≥n iniciada correctamente', 'success');
                } catch (error) {
                    console.error('Error en onLoginSuccess:', error);
                    showSyncStatus('error');
                    notify('‚ö†Ô∏è Error al cargar datos: ' + error.message, 'error');
                }
            }
        };

        // ==================== SISTEMA DE SINCRONIZACI√ìN MEJORADO ====================
        const SyncSystem = {
            // --- BLINDAJE: Detectar cuando la pesta√±a despierta ---
            initWakeUpListeners() {
                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === 'visible' && currentUser) {
                        console.log("üëÅÔ∏è App despert√≥: Forzando actualizaci√≥n...");
                        this.downloadFromFirebase();
                    }
                });
                window.addEventListener("focus", () => {
                    if (currentUser) this.downloadFromFirebase();
                });
            },

            async downloadFromFirebase() {
                if (!currentUser) return;
                try {
                    const userRef = database.ref(`users/${currentUser.uid}`);
                    const snapshot = await userRef.once('value');
                    const firebaseData = snapshot.val();
                    
                    if (firebaseData && firebaseData.products) {
                        console.log('‚úÖ Datos encontrados en Firebase, actualizando...');
                        state.products = firebaseData.products || [];
                        state.movements = firebaseData.movements || [];
                        state.operator = firebaseData.operator || '';
                        state.platforms = firebaseData.platforms || [];
                        state.adminPassword = firebaseData.adminPassword || '';
                        state.brandLogo = firebaseData.brandLogo || '';
                        
                        if (state.brandLogo) {
                            document.getElementById('logoImg').src = state.brandLogo;
                            document.getElementById('logoImg').style.display = 'block';
                            document.getElementById('logoPlaceholder').style.display = 'none';
                        }
                        if (document.getElementById('operatorInput')) document.getElementById('operatorInput').value = state.operator;
                    } else if (!firebaseData || !firebaseData.products) {
                        if (state.products.length > 0 || state.movements.length > 0) {
                            await this.uploadToFirebase();
                        }
                    }
                    this.saveToLocalStorage();
                    updateStats();
                    if (state.currentTab === 'productos') { renderProducts(); updateModelSummary(); }
                    if (state.currentTab === 'movimientos') renderMovements();
                } catch (error) {
                    console.error('Error descargando de Firebase:', error);
                    throw error;
                }
            },
            
            async uploadToFirebase() {
                if (!currentUser || syncInProgress) return;
                try {
                    syncInProgress = true;
                    showSyncStatus('syncing');
                    const userRef = database.ref(`users/${currentUser.uid}`);
                    
                    // --- BLINDAJE: Usar TRANSACTION para evitar sobrescritura ---
                    await userRef.transaction((currentData) => {
                        if (currentData === null) {
                            return {
                                products: state.products,
                                movements: state.movements.slice(-1000),
                                operator: state.operator,
                                platforms: state.platforms,
                                adminPassword: state.adminPassword,
                                brandLogo: state.brandLogo,
                                lastUpdate: Date.now(),
                                deviceInfo: { userAgent: navigator.userAgent, lastSync: new Date().toISOString() }
                            };
                        }
                        // Fusi√≥n segura: usamos nuestros datos actuales (ya actualizados al despertar)
                        return {
                            ...currentData,
                            products: state.products,
                            movements: state.movements.slice(-1000),
                            lastUpdate: Date.now()
                        };
                    });
                    
                    lastSyncTime = Date.now();
                    console.log('‚úÖ Datos sincronizados con Firebase');
                    showSyncStatus('success');
                } catch (error) {
                    console.error('Error sincronizando con Firebase:', error);
                    showSyncStatus('error');
                    notify('‚ö†Ô∏è Error al sincronizar: ' + error.message, 'warning');
                } finally {
                    syncInProgress = false;
                }
            },
            
            startRealtimeSync() {
                if (!currentUser) return;
                const userRef = database.ref(`users/${currentUser.uid}`);
                let isFirstSync = true;
                
                userRef.on('value', (snapshot) => {
                    if (isFirstSync) { isFirstSync = false; return; }
                    if (preventSync) return;
                    
                    const firebaseData = snapshot.val();
                    if (!firebaseData) return;
                    
                    if (firebaseData.lastUpdate && firebaseData.lastUpdate > lastSyncTime) {
                        console.log('üì• Actualizando desde Firebase (Realtime)...');
                        state.products = firebaseData.products || [];
                        state.movements = firebaseData.movements || [];
                        state.operator = firebaseData.operator || '';
                        state.platforms = firebaseData.platforms || [];
                        state.adminPassword = firebaseData.adminPassword || '';
                        state.brandLogo = firebaseData.brandLogo || '';
                        
                        this.saveToLocalStorage();
                        updateStats();
                        if (state.currentTab === 'productos') { renderProducts(); updateModelSummary(); }
                        if (state.currentTab === 'movimientos') renderMovements();
                        updatePlatformSelects();
                        lastSyncTime = firebaseData.lastUpdate;
                    }
                });
            },
            
            saveToLocalStorage() {
                try {
                    localStorage.setItem('inventory_state', JSON.stringify({
                        products: state.products, movements: state.movements, operator: state.operator,
                        platforms: state.platforms, adminPassword: state.adminPassword, brandLogo: state.brandLogo,
                        timestamp: Date.now()
                    }));
                } catch (e) { console.error('Error guardando en localStorage:', e); }
            }
        };

        // ==================== FUNCIONES DE LOGIN/REGISTRO ====================
        function toggleLoginMode(mode) {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginBtn = document.querySelector('.mode-btn[onclick*="login"]');
            const registerBtn = document.querySelector('.mode-btn[onclick*="register"]');
            
            if (mode === 'login') {
                loginForm.style.display = 'flex'; registerForm.style.display = 'none';
                loginBtn.classList.add('active'); registerBtn.classList.remove('active');
            } else {
                loginForm.style.display = 'none'; registerForm.style.display = 'flex';
                loginBtn.classList.remove('active'); registerBtn.classList.add('active');
            }
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('register-error').style.display = 'none';
            document.getElementById('login-success').style.display = 'none';
            document.getElementById('register-success').style.display = 'none';
        }

        const AUTHORIZED_EMAILS = [
            'johnsilverjeanselektra@gmail.com',
            'admin@johnsilver.com',
            'inventario@johnsilver.com'
        ];

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value.toLowerCase();
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            const submitBtn = document.getElementById('login-submit-btn');
            const errorDiv = document.getElementById('login-error');
            const successDiv = document.getElementById('login-success');
            
            if (!AUTHORIZED_EMAILS.includes(email)) {
                errorDiv.textContent = '‚ùå Acceso denegado. Email no autorizado.';
                errorDiv.style.display = 'block'; submitBtn.disabled = false; submitBtn.textContent = 'Iniciar Sesi√≥n'; return;
            }
            
            submitBtn.disabled = true; submitBtn.textContent = 'Iniciando sesi√≥n...';
            errorDiv.style.display = 'none'; successDiv.style.display = 'none';
            
            try {
                const persistence = rememberMe ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
                await auth.setPersistence(persistence);
                await auth.signInWithEmailAndPassword(email, password);
                localStorage.setItem('last_login_time', Date.now().toString());
                successDiv.textContent = '‚úÖ Iniciando sesi√≥n...'; successDiv.style.display = 'block';
            } catch (error) {
                let errorMessage = 'Error al iniciar sesi√≥n';
                if(error.code === 'auth/wrong-password') errorMessage = 'Contrase√±a incorrecta';
                else if(error.code === 'auth/user-not-found') errorMessage = 'Usuario no encontrado';
                errorDiv.textContent = errorMessage; errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false; submitBtn.textContent = 'Iniciar Sesi√≥n';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const email = document.getElementById('register-email').value.toLowerCase();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;
            const submitBtn = document.getElementById('register-submit-btn');
            const errorDiv = document.getElementById('register-error');
            const successDiv = document.getElementById('register-success');
            
            errorDiv.style.display = 'none'; successDiv.style.display = 'none';
            if (!AUTHORIZED_EMAILS.includes(email)) { errorDiv.textContent = '‚ùå Email no autorizado.'; errorDiv.style.display = 'block'; return; }
            if (password !== confirmPassword) { errorDiv.textContent = 'Las contrase√±as no coinciden'; errorDiv.style.display = 'block'; return; }
            if (password.length < 6) { errorDiv.textContent = 'M√≠nimo 6 caracteres'; errorDiv.style.display = 'block'; return; }
            
            submitBtn.disabled = true; submitBtn.textContent = 'Creando cuenta...';
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                localStorage.setItem('last_login_time', Date.now().toString());
                successDiv.textContent = '‚úÖ Cuenta creada. Iniciando...'; successDiv.style.display = 'block';
            } catch (error) {
                errorDiv.textContent = "Error: " + error.message; errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false; submitBtn.textContent = 'Crear Cuenta';
            }
        }

        async function handleLogout() {
            if (confirm('¬øCerrar sesi√≥n? Se guardar√° todo en la nube antes de salir.')) {
                try {
                    await SyncSystem.uploadToFirebase();
                    await auth.signOut();
                    notify('üëã Sesi√≥n cerrada', 'info');
                } catch (error) {
                    console.error('Error logout:', error);
                }
            }
        }

        function showSyncStatus(status) {
            const statusBar = document.getElementById('sync-status-bar');
            statusBar.className = '';
            if(status === 'syncing') statusBar.classList.add('syncing');
            else if(status === 'error') statusBar.classList.add('error');
            else if(status === 'success') { statusBar.style.display = 'block'; setTimeout(() => statusBar.style.display = 'none', 2000); }
        }

        function updateConnectionStatus(online) {
            if (online) { if (currentUser) SyncSystem.uploadToFirebase(); }
            else notify('‚ö†Ô∏è Sin conexi√≥n. Los cambios se guardar√°n localmente.', 'warning');
        }

        async function forceSyncFromFirebase() {
            if (!currentUser) return;
            if (confirm('¬øSincronizar con la nube?')) {
                try {
                    showSyncStatus('syncing');
                    await SyncSystem.downloadFromFirebase();
                    notify('‚úÖ Datos sincronizados', 'success');
                    showSyncStatus('success');
                } catch (error) { notify('‚ùå Error al sincronizar', 'error'); showSyncStatus('error'); }
            }
        }

        let saveTimeout;
        function saveState() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                preventSync = true;
                SyncSystem.saveToLocalStorage();
                if (currentUser && isOnline && !syncInProgress) {
                    SyncSystem.uploadToFirebase().then(() => { setTimeout(() => preventSync = false, 1000); });
                } else { setTimeout(() => preventSync = false, 1000); }
            }, 500);
        }

        // ==================== FUNCIONES DE INVENTARIO ====================
        function generateId() { return Math.random().toString(36).substr(2) + Date.now().toString(36); }
        function formatMoney(amount) { return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount || 0); }
        function formatDateTime(timestamp) { return new Date(timestamp).toLocaleString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }

        function notify(message, type = 'info') {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification ${type} animate-in`;
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            notification.innerHTML = `<span class="notification-icon">${icons[type]}</span><span class="notification-message">${message}</span><span class="notification-close" onclick="this.parentElement.remove()">√ó</span>`;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }
        function showError(message) { const errorDiv = document.getElementById('login-error'); if (errorDiv) { errorDiv.textContent = message; errorDiv.style.display = 'block'; } }

        function setTab(tab, element) {
            state.currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (!element) element = document.querySelector(`.tab[data-tab="${tab}"]`);
            if (element) element.classList.add('active');
            
            document.getElementById('scanPanel').style.display = (tab === 'entradas' || tab === 'salidas') ? 'block' : 'none';
            document.getElementById('productsSection').style.display = tab === 'productos' ? 'block' : 'none';
            document.getElementById('movementsSection').style.display = tab === 'movimientos' ? 'block' : 'none';
            document.getElementById('toolsSection').style.display = tab === 'herramientas' ? 'block' : 'none';
            document.getElementById('analyticsSection').style.display = tab === 'analytics' ? 'block' : 'none';
            document.getElementById('modelSummary').style.display = tab === 'productos' ? 'block' : 'none';
            
            if (tab === 'entradas' || tab === 'salidas') {
                const isEntrada = tab === 'entradas';
                document.getElementById('scanTitle').textContent = `${isEntrada ? 'Entradas' : 'Salidas'} ‚Ä¢ Escaneo r√°pido`;
                document.getElementById('scanType').value = isEntrada ? 'entrada' : 'salida';
                document.getElementById('scanIcon').textContent = isEntrada ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è';
                document.getElementById('returnGroup').style.display = isEntrada ? 'flex' : 'none';
                const btn = document.querySelector('.scan-panel .btn-success, .scan-panel .btn-danger');
                if (btn) btn.className = isEntrada ? 'btn btn-success' : 'btn btn-danger';
            }
            if (tab === 'productos') { renderProducts(); updateModelSummary(); }
            if (tab === 'movimientos') renderMovements();
            if (tab === 'herramientas') renderPlatforms();
            if (tab === 'analytics') {
                if (!state.valuesUnlocked) { document.getElementById('analyticsLocked').style.display = 'block'; document.getElementById('analyticsContent').style.display = 'none'; }
                else { document.getElementById('analyticsLocked').style.display = 'none'; document.getElementById('analyticsContent').style.display = 'block'; updateAnalytics(); }
            }
        }

        function updateStats() {
            const totalUnits = state.products.reduce((sum, p) => sum + (p.stock || 0), 0);
            const totalValue = state.products.reduce((sum, p) => sum + ((p.price || 0) * (p.stock || 0)), 0);
            const lowStock = state.products.filter(p => p.stock < (p.minStock || 0)).length;
            document.getElementById('statProducts').textContent = state.products.length;
            document.getElementById('statUnits').textContent = state.valuesUnlocked ? totalUnits.toLocaleString() : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            document.getElementById('statValue').textContent = state.valuesUnlocked ? formatMoney(totalValue) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            document.getElementById('statLowStock').textContent = lowStock;
            document.getElementById('lowStockIcon').style.color = lowStock > 0 ? 'var(--warning)' : 'inherit';
        }

        function updateModelSummary() {
            const modelStats = new Map();
            state.products.forEach(p => {
                const model = p.model || '(Sin modelo)';
                if (!modelStats.has(model)) modelStats.set(model, { units: 0, skus: 0, lowStock: 0 });
                const stats = modelStats.get(model);
                stats.units += p.stock || 0; stats.skus += 1;
                if (p.stock < (p.minStock || 0)) stats.lowStock += 1;
            });
            const container = document.getElementById('modelTags');
            container.innerHTML = '';
            modelStats.forEach((stats, model) => {
                const tag = document.createElement('div'); tag.className = 'model-tag';
                if (state.modelFilter === model) tag.classList.add('active');
                const lowStockBadge = stats.lowStock > 0 ? `<span style="background: var(--danger); color: white; padding: 0.125rem 0.375rem; border-radius: 999px; font-size: 0.7rem; margin-left: 0.25rem;">‚ö†Ô∏è ${stats.lowStock}</span>` : '';
                tag.innerHTML = `<strong>${model}:</strong> ${stats.units} unidades ‚Ä¢ ${stats.skus} SKUs${lowStockBadge}`;
                tag.style.cursor = 'pointer';
                tag.onclick = () => { if (state.modelFilter === model) setModelFilter('all'); else setModelFilter(model); };
                container.appendChild(tag);
            });
        }

        function toggleValues() {
            if (!state.valuesUnlocked) {
                if (!state.adminPassword) { notify('‚ö†Ô∏è Primero configura una contrase√±a', 'warning'); setTab('herramientas'); return; }
                const password = prompt('üîê Contrase√±a:');
                if (password === state.adminPassword) { state.valuesUnlocked = true; notify('‚úÖ Desbloqueado', 'success'); }
                else if (password !== null) notify('‚ùå Contrase√±a incorrecta', 'error');
            } else {
                state.valuesUnlocked = false; notify('üîí Oculto', 'info');
            }
            document.getElementById('valuesIcon').textContent = state.valuesUnlocked ? 'üîì' : 'üëÅÔ∏è';
            document.getElementById('valuesText').textContent = state.valuesUnlocked ? 'Ocultar datos' : 'Ver datos';
            updateStats(); renderProducts();
        }

        function processScan(event) {
            if (event) event.preventDefault();
            const barcode = document.getElementById('barcodeInput').value.trim();
            if (!barcode) return;
            
            const type = document.getElementById('scanType').value;
            const qty = document.getElementById('autoPlus').checked ? 1 : parseInt(document.getElementById('scanQty').value) || 1;
            const addTracking = document.getElementById('addTracking').checked;
            const noGuide = document.getElementById('noGuide').checked;
            
            let product = state.products.find(p => p.barcode === barcode);
            
            if (addTracking && !noGuide) {
                if (!product) {
                    state.pendingGuide = barcode;
                    document.getElementById('pendingGuideText').textContent = barcode;
                    document.getElementById('pendingGuide').style.display = 'block';
                    document.getElementById('barcodeInput').value = ''; document.getElementById('barcodeInput').focus();
                    return;
                }
            }
            if (!product) {
                product = { id: generateId(), barcode: barcode, name: 'Producto nuevo', color: 'Sin definir', stock: 0, createdAt: Date.now(), updatedAt: Date.now() };
                state.products.push(product);
            }
            const movement = { id: generateId(), productId: product.id, barcode: product.barcode, type: type, qty: qty, when: Date.now(), operator: state.operator, platform: document.getElementById('platformSelect').value, tracking: state.pendingGuide || '', isReturn: document.getElementById('isReturn').checked };
            
            if (type === 'entrada') product.stock = (product.stock || 0) + qty;
            else product.stock = Math.max(0, (product.stock || 0) - qty);
            product.updatedAt = Date.now();
            
            state.movements.unshift(movement);
            notify(`${type === 'entrada' ? '+' : '-'}${qty} ${product.name}`, 'success');
            playBeep();
            
            document.getElementById('barcodeInput').value = ''; document.getElementById('barcodeInput').focus();
            document.getElementById('pendingGuide').style.display = 'none'; document.getElementById('noGuide').checked = false; state.pendingGuide = '';
            
            saveState(); updateStats();
            if (state.currentTab === 'productos') { renderProducts(); updateModelSummary(); }
            if (state.currentTab === 'movimientos') renderMovements();
        }

        function playBeep() {
            try { const a=new(window.AudioContext||window.webkitAudioContext)(),o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.frequency.value=880;g.gain.value=0.05;o.start();setTimeout(()=>{o.stop();a.close()},120) } catch(e){}
        }

        // ==================== MOBILE SCANNER ====================
        let scanConfirmations = {}; let scanTimeout = null;
        function openMobileScanner() {
            document.getElementById('scannerModal').classList.add('active'); state.scannerActive = true; scanConfirmations = {};
            document.getElementById('scannerStatusText').textContent = 'üîÑ Iniciando c√°mara...';
            Quagga.init({ inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#scanner-viewport'), constraints: { facingMode: "environment" } }, decoder: { readers: ["code_128_reader", "ean_reader"] } }, function(err) { if(!err) Quagga.start(); document.getElementById('scannerStatusText').textContent = 'üîç Apunta la c√°mara al c√≥digo'; });
            Quagga.onDetected((result) => {
                const code = result.codeResult.code;
                if (code.length < 4) return;
                if (!scanConfirmations[code]) scanConfirmations[code] = 1; else scanConfirmations[code]++;
                document.getElementById('scannerStatusText').textContent = `Verificando... (${scanConfirmations[code]}/3)`;
                if (scanConfirmations[code] >= 3) {
                    document.getElementById('scannerResultCode').textContent = code; document.getElementById('scannerResult').style.display = 'block';
                    Quagga.stop(); setTimeout(() => { processScanFromMobile(code); closeMobileScanner(); }, 1000);
                }
            });
        }
        function closeMobileScanner() { document.getElementById('scannerModal').classList.remove('active'); state.scannerActive = false; Quagga.stop(); }
        function processScanFromMobile(code) { document.getElementById('barcodeInput').value = code; processScan(); }

        // ==================== RENDER PRODUCTOS ====================
        function renderProducts() {
            const tbody = document.getElementById('productsTable'); if (!tbody) return;
            let filtered = state.products;
            if (state.searchQuery) { const q=state.searchQuery.toLowerCase(); filtered = filtered.filter(p=>p.name?.toLowerCase().includes(q)||p.barcode?.includes(q)); }
            if (state.colorFilter !== 'all') filtered = filtered.filter(p=>p.color===state.colorFilter);
            if (state.modelFilter !== 'all') filtered = filtered.filter(p=>p.model===state.modelFilter);
            if (state.barcodeFilter === 'nocode') filtered = filtered.filter(p=>!p.barcode);
            if (state.lowStockFilter) filtered = filtered.filter(p=>p.stock<(p.minStock||0));
            
            tbody.innerHTML = '';
            if(filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="12" class="empty-state">No hay productos</td></tr>'; document.getElementById('productsCount').textContent = '(0)'; return; }
            
            filtered.forEach(p => {
                const row = tbody.insertRow();
                const stockClass = p.stock===0?'stock-zero':p.stock<(p.minStock||0)?'stock-low':'stock-ok';
                row.innerHTML = `<td>${p.image?'üì∑':'üñºÔ∏è'}</td><td>${p.model||'-'}</td><td style="font-family:monospace">${p.barcode||'-'}</td><td><strong>${p.name}</strong></td><td>${p.color}</td><td>${p.size||'-'}</td><td>${state.valuesUnlocked?formatMoney(p.price):'‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</td><td>${p.minStock||0}</td><td><span class="stock-badge ${stockClass}">${p.stock}</span></td><td>${p.platform||'-'}</td><td>${p.tracking||'-'}</td><td><div class="action-buttons"><button class="action-btn plus" onclick="quickStock('${p.id}','entrada')">+1</button><button class="action-btn minus" onclick="quickStock('${p.id}','salida')">-1</button><button class="action-btn" onclick="editProduct('${p.id}')">‚úèÔ∏è</button><button class="action-btn" onclick="deleteProduct('${p.id}')">üóëÔ∏è</button></div></td>`;
            });
            document.getElementById('productsCount').textContent = `(${filtered.length} total)`;
            updateColorFilters(); updateModelFilters();
        }

        function updateColorFilters() {
            const c = document.getElementById('colorFilters'); c.innerHTML='';
            [...new Set(state.products.map(p=>p.color).filter(Boolean))].sort().slice(0,3).forEach(color=>{
                const btn=document.createElement('button'); btn.className=state.colorFilter===color?'filter-btn active':'filter-btn'; btn.innerHTML=`<span>üé®</span> ${color}`; btn.onclick=()=>setColorFilter(color); c.appendChild(btn);
            });
        }
        function updateModelFilters() {
            const c = document.getElementById('modelFilters'); c.innerHTML='';
            [...new Set(state.products.map(p=>p.model).filter(Boolean))].sort().slice(0,3).forEach(model=>{
                const btn=document.createElement('button'); btn.className=state.modelFilter===model?'filter-btn active':'filter-btn'; btn.innerHTML=`<span>üëî</span> ${model}`; btn.onclick=()=>setModelFilter(state.modelFilter===model?'all':model); c.appendChild(btn);
            });
        }
        function setColorFilter(c){state.colorFilter=c;renderProducts();}
        function setModelFilter(m){state.modelFilter=m;updateModelSummary();renderProducts();}
        function setBarcodeFilter(){state.barcodeFilter=state.barcodeFilter==='nocode'?'all':'nocode';renderProducts();}
        function setLowStockFilter(){state.lowStockFilter=!state.lowStockFilter; document.getElementById('lowStockFilterBtn').classList.toggle('active'); renderProducts();}
        function clearAllFilters(){state.searchQuery=''; state.colorFilter='all'; state.modelFilter='all'; state.lowStockFilter=false; document.getElementById('searchInput').value=''; renderProducts(); updateModelSummary();}
        function showLowStock(){state.lowStockFilter=true; setTab('productos'); document.getElementById('lowStockFilterBtn').classList.add('active'); renderProducts();}

        function quickStock(id, type) {
            const p = state.products.find(x=>x.id===id); if(!p)return;
            if(type==='entrada') p.stock++; else p.stock = Math.max(0, p.stock-1);
            state.movements.unshift({id:generateId(), productId:p.id, barcode:p.barcode, type:type, qty:1, when:Date.now(), operator:state.operator});
            saveState(); updateStats(); renderProducts();
        }

        // ==================== CRUD ====================
        function openAddModal(){state.editingProduct=null; document.getElementById('productForm').reset(); document.getElementById('addModal').classList.add('show');}
        function editProduct(id){
            const p=state.products.find(x=>x.id===id); if(!p)return; state.editingProduct=p;
            document.getElementById('modalBarcode').value=p.barcode; document.getElementById('modalName').value=p.name; document.getElementById('modalColor').value=p.color; document.getElementById('modalSize').value=p.size; document.getElementById('modalModel').value=p.model; document.getElementById('modalPrice').value=p.price; document.getElementById('modalStock').value=p.stock; document.getElementById('addModal').classList.add('show');
        }
        function saveProduct(e){
            e.preventDefault();
            const d={barcode:document.getElementById('modalBarcode').value, name:document.getElementById('modalName').value, color:document.getElementById('modalColor').value, size:document.getElementById('modalSize').value, model:document.getElementById('modalModel').value, price:parseFloat(document.getElementById('modalPrice').value)||0, stock:parseInt(document.getElementById('modalStock').value)||0, platform:document.getElementById('modalPlatform').value, tracking:document.getElementById('modalTracking').value, image:document.getElementById('modalImage').value};
            if(state.editingProduct) Object.assign(state.editingProduct, d, {updatedAt:Date.now()});
            else state.products.push({id:generateId(), ...d, createdAt:Date.now(), updatedAt:Date.now()});
            saveState(); updateStats(); renderProducts(); closeModal('addModal');
        }
        function deleteProduct(id){if(confirm('¬øBorrar?')){state.products=state.products.filter(p=>p.id!==id); saveState(); renderProducts();}}
        function closeModal(id){document.getElementById(id).classList.remove('show');}

        // ==================== MOVIMIENTOS & TOOLS ====================
        function renderMovements(){
            const tbody=document.getElementById('movementsTable'); tbody.innerHTML='';
            state.movements.slice(0,100).forEach(m=>{
                const p=state.products.find(x=>x.id===m.productId);
                const row=tbody.insertRow(); row.innerHTML=`<td>${formatDateTime(m.when)}</td><td>${m.barcode||'-'}</td><td>${p?.name||'Borrado'}</td><td>${p?.size||'-'}</td><td>${p?.color||'-'}</td><td>${p?.model||'-'}</td><td>${m.type}</td><td>${m.qty}</td><td>${m.operator||'-'}</td><td>${m.platform||'-'}</td><td>${m.tracking||'-'}</td><td>${m.isReturn?'S√≠':'-'}</td>`;
            });
        }
        function updatePlatformSelects(){
            const s=document.getElementById('platformSelect'); s.innerHTML='<option value="">(Sin plataforma)</option>'; state.platforms.forEach(p=>s.innerHTML+=`<option value="${p}">${p}</option>`);
        }
        function renderPlatforms(){ document.getElementById('platformsList').innerHTML=state.platforms.map(p=>`<div>üì± ${p} <button onclick="removePlatform('${p}')">x</button></div>`).join(''); }
        function removePlatform(n) { if(confirm('¬øEliminar?')) { state.platforms=state.platforms.filter(p=>p!==n); saveState(); renderPlatforms(); } }
        function addPlatform(){ const v=document.getElementById('newPlatform').value; if(v){state.platforms.push(v); saveState(); renderPlatforms();} }
        function savePassword(){state.adminPassword=document.getElementById('adminPassword').value; saveState(); notify('Guardado');}

        // ==================== EXPORT ====================
        function clearAll(){if(prompt('Pass:')===state.adminPassword && confirm('¬øBorrar todo?')){state.products=[];state.movements=[];saveState();window.location.reload();}}
        function exportProductsCSV(){downloadFile("ID,Name,Stock\n"+state.products.map(p=>`${p.barcode},${p.name},${p.stock}`).join("\n"), 'inv.csv');}
        function exportMovementsCSV(){downloadFile("Date,Type,Product,Qty\n"+state.movements.map(m=>`${new Date(m.when).toISOString()},${m.type},${m.barcode},${m.qty}`).join("\n"), 'mov.csv');}
        function exportJSON(){downloadFile(JSON.stringify(state), 'backup.json');}
        function downloadFile(c,n,t){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([c],{type:t||'text/plain'}));a.download=n;a.click();}
        function downloadCSVTemplate(){downloadFile('barcode,name,color\n123,Test,Blue', 'template.csv');}
        function openBulkModal(){document.getElementById('bulkModal').classList.add('show');}
        
        function parseCSVLine(line) {
            const result = []; let current = ''; let inQuotes = false;
            for (let i=0; i<line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim()); return result;
        }

        function processCSV(mode) {
            const text = document.getElementById('csvText').value; if(!text)return;
            const lines = text.split(/\r?\n/).filter(l=>l.trim());
            const headers = parseCSVLine(lines[0]);
            const products = [];
            for(let i=1; i<lines.length; i++){
                const v = parseCSVLine(lines[i]);
                if(v.some(x=>x)){
                    products.push({
                        id:generateId(), barcode:v[headers.indexOf('barcode')]||'', name:v[headers.indexOf('name')]||'Item',
                        color:v[headers.indexOf('color')]||'', stock:parseInt(v[headers.indexOf('stock')])||0,
                        price:parseFloat(v[headers.indexOf('price')])||0, createdAt:Date.now()
                    });
                }
            }
            if(mode==='replace') state.products = products;
            else state.products.push(...products);
            saveState(); updateStats(); renderProducts(); closeModal('bulkModal');
        }
        
        function handleLogoUpload(e){
            const f=e.target.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=ev=>{state.brandLogo=ev.target.result;document.getElementById('logoImg').src=state.brandLogo;document.getElementById('logoImg').style.display='block';document.getElementById('logoPlaceholder').style.display='none';saveState();};
            r.readAsDataURL(f);
        }

        // ==================== ANALYTICS COMPLETO ====================
        function unlockAnalytics() {
            if (!state.adminPassword) { notify('‚ö†Ô∏è Primero configura una contrase√±a', 'warning'); setTab('herramientas'); return; }
            if (prompt('üîê Contrase√±a:') === state.adminPassword) { state.valuesUnlocked = true; document.getElementById('analyticsLocked').style.display = 'none'; document.getElementById('analyticsContent').style.display = 'block'; updateAnalytics(); }
        }
        function lockAnalytics(){state.valuesUnlocked=false; document.getElementById('analyticsLocked').style.display='block'; document.getElementById('analyticsContent').style.display='none';}

        let charts = {};
        function updateAnalytics(){ 
            // L√≥gica completa de analytics restaurada
            const now = new Date(); const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthMovements = state.movements.filter(m => m.when >= startOfMonth.getTime());
            const monthSales = monthMovements.filter(m => m.type === 'salida').reduce((sum, m) => sum + m.qty, 0);
            document.getElementById('monthSales').textContent = monthSales.toLocaleString();
            
            let monthRevenue = 0;
            monthMovements.filter(m => m.type === 'salida').forEach(m => {
                const product = state.products.find(p => p.id === m.productId);
                if (product && product.price) monthRevenue += product.price * m.qty;
            });
            document.getElementById('monthRevenue').textContent = formatMoney(monthRevenue);
            
            if(charts.daily) charts.daily.destroy();
            if(charts.top) charts.top.destroy();
            
            const ctx1=document.getElementById('dailyMovementsChart').getContext('2d');
            charts.daily = new Chart(ctx1, {type:'line', data:{labels:['Hoy'], datasets:[{label:'Movimientos', data:[state.movements.length]}]}});
        }

        // ==================== INIT ====================
        window.addEventListener('DOMContentLoaded', () => { AuthSystem.init(); });
        document.addEventListener('keydown', (e) => { if(e.key==='Escape') closeModal('addModal'); });
    </script>
</body>
</html>
